# Issue #371 - Task 04: Add comprehensive tests for generator and CLI

## Overview
Create comprehensive test suites for the invoice generator service, command class, and CLI integration to achieve 100% branch coverage. This task consolidates all testing efforts and ensures quality gates are met.

## Related Information
- **Input Source**: `local/develop/issue_371.md`
- **Overview Document**: `docs/develop/issue_371_overview.md`
- **Dependencies**: Tasks 01, 02, and 03 must be completed first

## Target Files
- [ ] `tests/invoice_generator/test_invoice_generator.py` (from Task 01)
- [ ] `tests/cmd/test_gen_invoice.py` (from Task 02)
- [ ] `tests/cli/test_gen_invoice_cli.py` (from Task 03)
- [ ] `tests/invoice_generator/test_integration.py` (new integration tests)

## Implementation Steps

### Step 1: Complete invoice generator unit tests
Ensure `tests/invoice_generator/test_invoice_generator.py` covers:

**Schema Loading & Validation**
- Valid schema loads successfully
- FileNotFoundError for non-existent schema
- ValueError for invalid JSON syntax
- InvoiceSchemaValidationError for invalid schema structure

**Default Value Generation**
- Each type: string → "", number → 0.0, integer → 0, boolean → false, array → [], object → {}
- Schema default takes precedence
- Schema examples used when fill_defaults=True
- Type-based defaults when no schema default/examples
- fill_defaults=False returns None/empty for optional fields

**Custom Field Processing**
- Simple types (string, number, integer, boolean)
- Complex constraints (enum, pattern, min/max, minLength/maxLength)
- Required vs optional custom fields
- required_only=True includes only required custom fields
- required_only=False includes all custom properties

**Sample Field Processing**
- With generalAttributes (populated correctly)
- With specificAttributes (populated correctly)
- Without sample section (section omitted)
- Sample required fields always included

**Basic Section Generation**
- System-required fields: datasetId, basic
- Basic fields: dateSubmitted, dataOwnerId, dataName
- Optional basic fields: instrumentId, experimentId, description

**File Output**
- Write to file when output_path provided
- Return dict when output_path=None
- Parent directories created automatically
- File written with UTF-8 encoding

**Validation Integration**
- Generated invoice passes InvoiceValidator
- Invalid generated invoice raises InvoiceSchemaValidationError
- Validation errors provide clear messages

### Step 2: Complete command class tests
Ensure `tests/cmd/test_gen_invoice.py` covers:

**Successful Generation**
- Default options (fill_defaults=True, required_only=False, format=pretty)
- fill_defaults=False
- required_only=True
- output_format=compact
- All option combinations

**Error Handling**
- Schema file not found → typer.Abort
- Invalid schema → typer.Abort
- Validation failure → typer.Abort
- Permission error on output → typer.Abort

**Output Formatting**
- Pretty format has indentation
- Compact format has no whitespace
- UTF-8 encoding preserved
- ensure_ascii=False for non-ASCII characters

**Message Display**
- Info messages shown during processing
- Success messages shown on completion
- Error messages shown on failure
- All exceptions logged before abort

### Step 3: Complete CLI integration tests
Ensure `tests/cli/test_gen_invoice_cli.py` covers:

**Argument/Option Parsing**
- Positional schema_path argument required
- Optional -o/--output option
- Boolean --fill-defaults/--no-fill-defaults flag
- Boolean --required-only flag
- --format option validation

**Default Values**
- output_path defaults to ./invoice.json
- fill_defaults defaults to True
- required_only defaults to False
- format defaults to "pretty"

**Input Validation**
- Schema must be .json file
- Schema must be valid JSON
- Format must be "pretty" or "compact"
- Non-existent schema file rejected

**CLI Output**
- Exit code 0 on success
- Exit code 1 on error
- Success messages in stdout
- Error messages in stdout
- Help text accessible

### Step 4: Create integration tests
Create `tests/invoice_generator/test_integration.py` for end-to-end scenarios:

```python
# tests/invoice_generator/test_integration.py

import pytest
from pathlib import Path
from rdetoolkit.invoice_generator import generate_invoice_from_schema
from rdetoolkit.validation import InvoiceValidator


class TestInvoiceGeneratorIntegration:
    """Integration tests for invoice generation with real schemas.

    These tests use actual invoice.schema.json files from the project
    to ensure the generator works with real-world schemas.
    """

    def test_generate_from_project_schema(self, tmp_path):
        # Given: Project's actual invoice.schema.json
        project_schema = Path("src/rdetoolkit/static/invoice.schema.json")
        if not project_schema.exists():
            pytest.skip("Project schema not found")

        output_path = tmp_path / "invoice.json"

        # When: Generate invoice
        result = generate_invoice_from_schema(
            project_schema,
            output_path,
            fill_defaults=True,
            required_only=False,
        )

        # Then: Output file created and passes validation
        assert output_path.exists()
        assert isinstance(result, dict)

        validator = InvoiceValidator(project_schema)
        validated = validator.validate(path=output_path)
        assert validated == result

    def test_generate_minimal_schema(self, tmp_path):
        # Given: Minimal valid schema (only required fields)
        schema = {
            "$schema": "https://json-schema.org/draft/2020-12/schema",
            "$id": "https://rde.nims.go.jp/test",
            "type": "object",
            "properties": {},
        }
        schema_path = tmp_path / "minimal.schema.json"
        import json
        with open(schema_path, "w") as f:
            json.dump(schema, f)

        output_path = tmp_path / "invoice.json"

        # When: Generate invoice
        result = generate_invoice_from_schema(
            schema_path,
            output_path,
            fill_defaults=True,
        )

        # Then: Basic structure created
        assert "datasetId" in result
        assert "basic" in result
        assert output_path.exists()

    def test_generate_with_custom_and_sample(self, tmp_path):
        # Given: Schema with custom and sample sections
        # ... create comprehensive schema

        # When: Generate invoice
        result = generate_invoice_from_schema(
            schema_path,
            output_path,
            fill_defaults=True,
            required_only=False,
        )

        # Then: All sections populated correctly
        assert "custom" in result
        assert "sample" in result
        # ... verify structure
```

### Step 5: Run comprehensive test suite
```bash
# Run all invoice generator tests
tox -e py312-module -- tests/invoice_generator/ -v

# Run all command tests
tox -e py312-module -- tests/cmd/test_gen_invoice.py -v

# Run all CLI tests
tox -e py312-module -- tests/cli/test_gen_invoice_cli.py -v

# Run all related tests together
tox -e py312-module -- tests/invoice_generator/ tests/cmd/test_gen_invoice.py tests/cli/test_gen_invoice_cli.py -v

# Check coverage
tox -e py312-module -- tests/invoice_generator/ tests/cmd/test_gen_invoice.py tests/cli/test_gen_invoice_cli.py --cov=src/rdetoolkit/invoice_generator --cov=src/rdetoolkit/cmd/gen_invoice --cov-report=term-missing
```

### Step 6: Verify quality gates
```bash
# Type checking
tox -e mypy

# Linting
tox -e ruff

# Full test suite
tox -e py312-module
```

## Completion Criteria
- [ ] All test files created with complete test coverage
- [ ] Test design tables (EP/BV) documented for all test classes
- [ ] 100% branch coverage for invoice_generator module
- [ ] 100% branch coverage for cmd/gen_invoice module
- [ ] 100% branch coverage for CLI command in app.py
- [ ] Integration tests pass with real schemas
- [ ] All tests follow Given/When/Then structure
- [ ] All tests use pytest best practices (fixtures, parametrize, marks)
- [ ] `tox -e py312-module -- tests/invoice_generator/` passes
- [ ] `tox -e py312-module -- tests/cmd/test_gen_invoice.py` passes
- [ ] `tox -e py312-module -- tests/cli/test_gen_invoice_cli.py` passes
- [ ] `tox -e mypy` passes with no errors
- [ ] `tox -e ruff` passes with no violations
- [ ] Coverage report shows 100% for all new code

## Notes
- Use pytest fixtures for common setup (tmp_path, sample schemas)
- Use pytest.mark.parametrize for testing multiple scenarios
- Mock external dependencies (file I/O, validation) in unit tests
- Use real files in integration tests
- Ensure tests are isolated (no cross-test dependencies)
- Tests should be fast (use mocks, avoid slow operations)
- Clear assertion messages for debugging failures

## Test Fixtures to Create
```python
# conftest.py for invoice_generator tests

import pytest
from pathlib import Path


@pytest.fixture
def minimal_schema(tmp_path):
    """Minimal valid invoice.schema.json."""
    schema = {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "$id": "https://rde.nims.go.jp/test",
        "type": "object",
        "properties": {},
    }
    schema_path = tmp_path / "minimal.schema.json"
    import json
    with open(schema_path, "w") as f:
        json.dump(schema, f, indent=2)
    return schema_path


@pytest.fixture
def schema_with_custom(tmp_path):
    """Schema with custom fields."""
    # ... create schema with custom section
    return schema_path


@pytest.fixture
def schema_with_sample(tmp_path):
    """Schema with sample fields."""
    # ... create schema with sample section
    return schema_path


@pytest.fixture
def full_schema(tmp_path):
    """Schema with all sections (custom + sample)."""
    # ... create comprehensive schema
    return schema_path
```

## Coverage Analysis
After running tests, analyze coverage to identify gaps:
```bash
# Generate HTML coverage report
tox -e py312-module -- tests/invoice_generator/ tests/cmd/test_gen_invoice.py tests/cli/test_gen_invoice_cli.py --cov=src/rdetoolkit/invoice_generator --cov=src/rdetoolkit/cmd/gen_invoice --cov-report=html

# Open coverage report
open htmlcov/index.html

# Identify missing lines and add tests to cover them
```

## Example Parametrized Test
```python
@pytest.mark.parametrize(
    "value_type,schema_default,expected",
    [
        ("string", None, ""),
        ("string", "default_value", "default_value"),
        ("number", None, 0.0),
        ("number", 42.5, 42.5),
        ("integer", None, 0),
        ("boolean", None, False),
        ("boolean", True, True),
        ("array", None, []),
        ("object", None, {}),
    ],
)
def test_default_value_generation(value_type, schema_default, expected):
    # Given: Type and optional default
    # When: Get default value
    result = _get_default_value_for_type(
        value_type,
        schema_default=schema_default,
        fill_defaults=True,
    )
    # Then: Returns expected default
    assert result == expected
```
