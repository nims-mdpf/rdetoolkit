# Issue #371 - Task 03: Add CLI command for gen-invoice

## Overview
Register the new `gen-invoice` CLI command in `src/rdetoolkit/cli/app.py`, integrating the GenerateInvoiceCommand class with Typer's command routing system.

## Related Information
- **Input Source**: `local/develop/issue_371.md`
- **Overview Document**: `docs/develop/issue_371_overview.md`
- **Dependencies**: Task 02 must be completed first

## Target Files
- [x] `src/rdetoolkit/cli/app.py` (modify existing file)
- [x] `tests/test_cli_gen_invoice.py` (new file)

## Implementation Steps

### Step 1: Add CLI command function to app.py
```python
# src/rdetoolkit/cli/app.py
# Add after the make-excelinvoice command (around line 449)

@app.command("gen-invoice")
def gen_invoice(
    schema_path: Annotated[
        Path,
        typer.Argument(
            help="Path to invoice.schema.json file",
            exists=True,
            dir_okay=False,
            resolve_path=True,
        ),
    ],
    output_path: Annotated[
        Path | None,
        typer.Option(
            "-o",
            "--output",
            help="Path to output invoice.json file (default: ./invoice.json)",
            exists=False,
            dir_okay=False,
            resolve_path=True,
        ),
    ] = None,
    fill_defaults: Annotated[
        bool,
        typer.Option(
            "--fill-defaults/--no-fill-defaults",
            help="Populate type-based default values (default: True)",
        ),
    ] = True,
    required_only: Annotated[
        bool,
        typer.Option(
            "--required-only",
            help="Include only required fields from schema (default: False)",
        ),
    ] = False,
    output_format: Annotated[
        str,
        typer.Option(
            "--format",
            help="Output JSON format: 'pretty' (indented) or 'compact' (minified)",
            case_sensitive=False,
        ),
    ] = "pretty",
) -> None:
    """Generate invoice.json from invoice.schema.json.

    Creates a valid invoice.json file based on the structure and requirements
    defined in the provided invoice.schema.json file. Supports customization
    of default values, field inclusion, and output formatting.

    Examples:

        # Generate with all fields and defaults
        rdetoolkit gen-invoice invoice.schema.json

        # Generate to specific output path
        rdetoolkit gen-invoice invoice.schema.json -o output/invoice.json

        # Generate required fields only, no defaults
        rdetoolkit gen-invoice invoice.schema.json --required-only --no-fill-defaults

        # Generate with compact formatting
        rdetoolkit gen-invoice invoice.schema.json --format compact
    """
    # Lazy imports
    from typing import Literal, cast
    from rdetoolkit.cmd.gen_invoice import GenerateInvoiceCommand

    # Set default output path if not provided
    final_output_path = output_path if output_path is not None else Path.cwd() / "invoice.json"

    # Validate JSON file (reuse existing validator)
    validated_schema_path = validate_json_file(schema_path)

    # Validate format option
    format_lower = output_format.lower()
    if format_lower not in ["pretty", "compact"]:
        msg = "Format must be 'pretty' or 'compact'"
        raise typer.BadParameter(
            msg,
            param_hint="--format",
        )

    # Create and invoke command
    cmd = GenerateInvoiceCommand(
        schema_path=validated_schema_path,
        output_path=final_output_path,
        fill_defaults=fill_defaults,
        required_only=required_only,
        output_format=cast(Literal["pretty", "compact"], format_lower),
    )
    cmd.invoke()
```

### Step 2: Ensure validate_json_file is accessible
The existing `validate_json_file` function (lines 28-57) should already be usable. Verify it's defined before the new command.

### Step 3: Create CLI integration tests
Design EP/BV test tables first, then implement tests:

**Test Categories**:
1. **Successful CLI Invocation Tests**
   - Default options (EP-001)
   - Custom output path (EP-002)
   - Required only flag (EP-003)
   - No fill defaults flag (EP-004)
   - Compact format (EP-005)
   - Combined options (EP-006)

2. **CLI Validation Tests**
   - Non-JSON schema file (BV-001)
   - Invalid JSON format (BV-002)
   - Invalid format option (BV-003)
   - Non-existent schema file (BV-004)

3. **Default Value Tests**
   - output_path defaults to ./invoice.json
   - fill_defaults defaults to True
   - required_only defaults to False
   - format defaults to "pretty"

4. **Error Message Tests**
   - Schema validation errors displayed
   - File not found errors displayed
   - Format validation errors displayed

## Completion Criteria
- [x] CLI command `gen-invoice` added to `app.py`
- [x] Command follows existing patterns (arguments, options, validation)
- [x] All parameters have proper Annotated types with help text
- [x] Docstring includes usage examples
- [x] validate_json_file reused for schema validation
- [x] Lazy imports used for command class
- [x] Test design tables (EP/BV) documented in test file
- [x] CLI tests implemented with 100% branch coverage (15 test cases)
- [x] Tests use typer.testing.CliRunner
- [x] `pytest tests/test_cli_gen_invoice.py` passes (15/15)
- [x] Manual CLI testing successful (help, error handling verified)

## Notes
- Follow the pattern from `make_excelinvoice` command (lines 392-448)
- Reuse `validate_json_file` for consistency
- Use lazy imports inside the command function
- Ensure proper parameter validation before calling command class
- Default output path should be `./invoice.json` in current directory
- Boolean flags use `--flag/--no-flag` pattern (Typer best practice)
- Format validation should provide clear error messages

## Example Test Structure
```python
# tests/cli/test_gen_invoice_cli.py

import pytest
from pathlib import Path
from typer.testing import CliRunner
from rdetoolkit.cli.app import app

runner = CliRunner()


class TestGenInvoiceCLI:
    """Test suite for gen-invoice CLI command.

    EP/BV Test Design:
    ==================

    | Test Case | Args/Options | Schema Valid | Expected Exit Code | Expected Output |
    |-----------|--------------|--------------|-------------------|-----------------|
    | EP-001    | schema.json  | Yes          | 0                 | Success message, invoice.json created |
    | EP-002    | schema.json -o out.json | Yes | 0 | Success message, out.json created |
    | EP-003    | schema.json --required-only | Yes | 0 | Success, only required fields |
    | EP-004    | schema.json --no-fill-defaults | Yes | 0 | Success, no defaults filled |
    | EP-005    | schema.json --format compact | Yes | 0 | Success, compact JSON |
    | BV-001    | schema.txt   | N/A          | 1                 | Error: must be JSON |
    | BV-002    | invalid.json | No           | 1                 | Error: invalid JSON |
    | BV-003    | schema.json --format invalid | Yes | 1 | Error: invalid format |
    | BV-004    | nonexistent.json | N/A | 1 | Error: file not found |
    | ...       | ...          | ...          | ...               | ... |
    """

    def test_ep001_default_options_success(self, tmp_path, monkeypatch):
        # Given: Valid schema file in temp directory
        monkeypatch.chdir(tmp_path)
        schema_path = tmp_path / "invoice.schema.json"
        # ... create valid schema

        # When: Run CLI with default options
        result = runner.invoke(app, ["gen-invoice", str(schema_path)])

        # Then: Exit code 0, invoice.json created, success message
        assert result.exit_code == 0
        assert "Successfully generated" in result.stdout
        assert (tmp_path / "invoice.json").exists()

    def test_ep002_custom_output_path(self, tmp_path):
        # Given: Valid schema and custom output path
        schema_path = tmp_path / "invoice.schema.json"
        # ... create valid schema
        output_path = tmp_path / "output" / "custom.json"

        # When: Run CLI with -o option
        result = runner.invoke(
            app,
            ["gen-invoice", str(schema_path), "-o", str(output_path)]
        )

        # Then: Exit code 0, custom.json created
        assert result.exit_code == 0
        assert output_path.exists()

    def test_bv001_non_json_file_error(self, tmp_path):
        # Given: Non-JSON file
        schema_path = tmp_path / "schema.txt"
        schema_path.write_text("not json")

        # When: Run CLI with .txt file
        result = runner.invoke(app, ["gen-invoice", str(schema_path)])

        # Then: Exit code 1, error message
        assert result.exit_code == 1
        assert "must be a JSON file" in result.stdout

    def test_bv003_invalid_format_option(self, tmp_path):
        # Given: Valid schema
        schema_path = tmp_path / "invoice.schema.json"
        # ... create valid schema

        # When: Run CLI with invalid format
        result = runner.invoke(
            app,
            ["gen-invoice", str(schema_path), "--format", "invalid"]
        )

        # Then: Exit code 1, error message
        assert result.exit_code == 1
        assert "must be 'pretty' or 'compact'" in result.stdout
```

## Manual Testing Checklist
After implementation, manually test these scenarios:
```bash
# 1. Help text
rdetoolkit gen-invoice --help

# 2. Default generation
rdetoolkit gen-invoice tests/static/invoice.schema.json

# 3. Custom output path
rdetoolkit gen-invoice tests/static/invoice.schema.json -o /tmp/invoice.json

# 4. Required only
rdetoolkit gen-invoice tests/static/invoice.schema.json --required-only

# 5. No defaults
rdetoolkit gen-invoice tests/static/invoice.schema.json --no-fill-defaults

# 6. Compact format
rdetoolkit gen-invoice tests/static/invoice.schema.json --format compact

# 7. Combined options
rdetoolkit gen-invoice tests/static/invoice.schema.json -o /tmp/test.json --required-only --format compact

# 8. Error: non-existent file
rdetoolkit gen-invoice nonexistent.json

# 9. Error: non-JSON file
rdetoolkit gen-invoice README.md

# 10. Error: invalid format
rdetoolkit gen-invoice tests/static/invoice.schema.json --format xml
```
