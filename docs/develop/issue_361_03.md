# Issue #361 - Task 03: Add YAML/TOML Parse Error Handling with Line Info

## Overview
Add comprehensive parse error handling for YAML and TOML files with line/column information. Replace generic exceptions with ConfigError that includes the exact location of syntax errors.

## Related Information
- **Input Source**: `local/develop/issue_361.md`
- **Overview Document**: `docs/develop/issue_361_overview.md`
- **Dependencies**: Task 01 (ConfigError class)

## Target Files
- [x] `src/rdetoolkit/config.py` (modify parse_config_file and __read_pyproject_toml)
- [x] `tests/test_config.py` (add parse error tests with invalid YAML/TOML files)

## Implementation Steps

### Step 1: Add YAML parse error handling with line information
Modify `parse_config_file()` to catch YAML parse errors and extract line/column information.

**Location**: `src/rdetoolkit/config.py`, function `parse_config_file()`

```python
import yaml
from yaml import YAMLError
from rdetoolkit.exceptions import ConfigError

def parse_config_file(*, path: str | None = None) -> Config:
    """Parse the configuration file and return a Config object.

    # ... docstring ...
    """
    # ... existing code for path validation and file type detection ...

    if path is not None and is_yaml(path):
        try:
            with open(path, encoding="utf-8") as f:
                config_data = yaml.safe_load(f)
        except YAMLError as e:
            # Extract line and column information from YAMLError
            line_number = None
            column_number = None

            if hasattr(e, 'problem_mark') and e.problem_mark is not None:
                line_number = e.problem_mark.line + 1  # YAML uses 0-indexed lines
                column_number = e.problem_mark.column + 1

            error_msg = f"Failed to parse YAML file: invalid syntax"
            if hasattr(e, 'problem'):
                error_msg = f"Failed to parse YAML file: {e.problem}"

            raise ConfigError(
                error_msg,
                file_path=path,
                error_type="parse_error",
                line_number=line_number,
                column_number=column_number,
            ) from e
        except (IOError, OSError) as e:
            raise ConfigError(
                f"Failed to read YAML file: {e}",
                file_path=path,
                error_type="io_error",
            ) from e

    # ... rest of the function ...
```

### Step 2: Add TOML parse error handling
Modify `__read_pyproject_toml()` to catch TOML parse errors with location information.

**Location**: `src/rdetoolkit/config.py`, function `__read_pyproject_toml()`

```python
from tomlkit.exceptions import TOMLKitError

def __read_pyproject_toml(path: str) -> dict[str, Any]:
    """Read the pyproject.toml file and return the contents as a dictionary.

    Args:
        path: Path to the pyproject.toml file

    Returns:
        dict[str, Any]: The contents of the pyproject.toml file.

    Raises:
        ConfigError: If the file cannot be parsed
    """
    # ... existing file existence check from Task 02 ...

    try:
        toml = TOMLFile(path)
        obj = toml.read()
        _obj = obj.unwrap()
        return _obj.get("tool", {}).get("rdetoolkit", {})
    except TOMLKitError as e:
        # Extract line information if available
        line_number = None
        if hasattr(e, 'line'):
            line_number = e.line

        error_msg = f"Failed to parse TOML file: {str(e)}"

        raise ConfigError(
            error_msg,
            file_path=path,
            error_type="parse_error",
            line_number=line_number,
        ) from e
    except (IOError, OSError) as e:
        raise ConfigError(
            f"Failed to read TOML file: {e}",
            file_path=path,
            error_type="io_error",
        ) from e
```

### Step 3: Add unit tests for parse errors

**Location**: `tests/test_config.py`

Add test fixtures and test cases following Given/When/Then pattern:

```python
import pytest
from rdetoolkit.exceptions import ConfigError


@pytest.fixture()
def invalid_yaml_syntax():
    """Create a YAML file with syntax error."""
    dirname = Path("tasksupport")
    dirname.mkdir(exist_ok=True)
    test_yaml_path = dirname.joinpath("invalid_syntax.yaml")

    # Invalid YAML: unclosed bracket, tabs instead of spaces, etc.
    invalid_content = """
system:
  extended_mode: rdeformat
  save_raw: true
  invalid_structure: [
    unclosed bracket here
multidata_tile:
  ignore_errors: false
"""
    with open(test_yaml_path, mode="w", encoding="utf-8") as f:
        f.write(invalid_content)

    yield test_yaml_path

    if test_yaml_path.exists():
        test_yaml_path.unlink()
    if dirname.exists():
        dirname.rmdir()


@pytest.fixture()
def invalid_toml_syntax():
    """Create a TOML file with syntax error."""
    dirname = Path("tasksupport")
    dirname.mkdir(exist_ok=True)
    test_toml_path = dirname.joinpath("pyproject.toml")

    # Invalid TOML: missing closing quote, invalid table definition
    invalid_content = """
[tool.rdetoolkit]
[tool.rdetoolkit.system]
extended_mode = "rdeformat
save_raw = true
"""
    with open(test_toml_path, mode="w", encoding="utf-8") as f:
        f.write(invalid_content)

    yield test_toml_path

    if test_toml_path.exists():
        test_toml_path.unlink()
    if dirname.exists():
        dirname.rmdir()


def test_parse_config_yaml_syntax_error(invalid_yaml_syntax):
    """Test ConfigError with line info for YAML syntax errors.

    Test ID: TC-PARSE-YAML-001
    """
    # Given: YAML file with syntax error
    yaml_path = str(invalid_yaml_syntax)

    # When: attempting to parse the file
    # Then: ConfigError is raised with parse error details
    with pytest.raises(ConfigError) as exc_info:
        parse_config_file(path=yaml_path)

    error = exc_info.value
    assert error.file_path == yaml_path
    assert error.error_type == "parse_error"
    assert "parse" in str(error).lower() or "syntax" in str(error).lower()
    # Line number should be present (YAML parser provides it)
    assert error.line_number is not None or "line" in str(error).lower()
    assert "https://nims-mdpf.github.io/rdetoolkit/" in str(error)


def test_parse_config_toml_syntax_error(invalid_toml_syntax):
    """Test ConfigError with line info for TOML syntax errors.

    Test ID: TC-PARSE-TOML-001
    """
    # Given: TOML file with syntax error
    toml_path = str(invalid_toml_syntax)

    # When: attempting to parse the file
    # Then: ConfigError is raised with parse error details
    with pytest.raises(ConfigError) as exc_info:
        parse_config_file(path=toml_path)

    error = exc_info.value
    assert error.file_path == toml_path
    assert error.error_type == "parse_error"
    assert "parse" in str(error).lower() or "toml" in str(error).lower()
    assert "https://nims-mdpf.github.io/rdetoolkit/" in str(error)


def test_parse_config_yaml_io_error(tmp_path):
    """Test ConfigError for file I/O errors.

    Test ID: TC-PARSE-IO-001
    """
    # Given: YAML file with restricted permissions (simulate I/O error)
    yaml_path = tmp_path / "unreadable.yaml"
    yaml_path.touch()
    yaml_path.chmod(0o000)  # Remove all permissions

    try:
        # When: attempting to parse the file
        # Then: ConfigError is raised with I/O error type
        with pytest.raises(ConfigError) as exc_info:
            parse_config_file(path=str(yaml_path))

        error = exc_info.value
        assert error.error_type == "io_error"
        assert str(yaml_path) in error.file_path
    finally:
        # Cleanup: restore permissions
        yaml_path.chmod(0o644)
```

## Completion Criteria
- [x] YAML parse errors caught and converted to ConfigError with line/column info
- [x] TOML parse errors caught and converted to ConfigError with line info
- [x] I/O errors (file read failures) handled separately from parse errors
- [x] All error messages include file path and error type
- [x] Line/column information included when available
- [x] Tests added for YAML syntax errors (1+ test case)
- [x] Tests added for TOML syntax errors (1+ test case)
- [x] Tests added for I/O errors (1+ test case)
- [x] Tests verify error attributes (type, file_path, line_number)
- [x] Tests pass (`tox -e py312-module -- tests/test_config.py`)
- [x] No new type errors (`tox -e mypy`)
- [x] Code follows project style (`tox -e ruff`)

## Notes
- YAML parser (PyYAML) provides `problem_mark` with line and column
- TOML parser (tomlkit) may provide line information in exceptions
- Line numbers in YAML are 0-indexed, convert to 1-indexed for user display
- Parse errors are different from validation errors (handled in Task 04)
- I/O errors should be distinguished from syntax errors
