# Issue #371 - Task 02: Create command class for invoice generation

## Overview
Create a command class `GenerateInvoiceCommand` in `src/rdetoolkit/cmd/gen_invoice.py` that wraps the invoice generator service and provides a Typer-compatible interface for CLI integration.

## Related Information
- **Input Source**: `local/develop/issue_371.md`
- **Overview Document**: `docs/develop/issue_371_overview.md`
- **Dependencies**: Task 01 must be completed first

## Target Files
- [x] `src/rdetoolkit/cmd/gen_invoice.py` (new file)
- [x] `tests/cmd/test_gen_invoice.py` (new file)

## Implementation Steps

### Step 1: Create command class following existing pattern
```python
# src/rdetoolkit/cmd/gen_invoice.py
from __future__ import annotations

from pathlib import Path
from typing import Literal

import typer

from rdetoolkit.rdelogger import get_logger

logger = get_logger(__name__)


class GenerateInvoiceCommand:
    """Command to generate invoice.json from invoice.schema.json.

    This command provides CLI functionality to create invoice.json files
    from invoice schema definitions, supporting various generation modes
    and output formats.

    Attributes:
        schema_path: Path to invoice.schema.json file.
        output_path: Path where invoice.json will be written.
        fill_defaults: Whether to populate type-based default values.
        required_only: Whether to include only required fields.
        output_format: Output JSON format ("pretty" or "compact").

    Example:
        >>> cmd = GenerateInvoiceCommand(
        ...     schema_path=Path("invoice.schema.json"),
        ...     output_path=Path("invoice.json"),
        ...     fill_defaults=True,
        ...     required_only=False,
        ...     output_format="pretty"
        ... )
        >>> cmd.invoke()
    """

    def __init__(
        self,
        schema_path: Path,
        output_path: Path,
        *,
        fill_defaults: bool = True,
        required_only: bool = False,
        output_format: Literal["pretty", "compact"] = "pretty",
    ):
        """Initialize the command with configuration.

        Args:
            schema_path: Path to invoice.schema.json file.
            output_path: Path where invoice.json will be written.
            fill_defaults: If True, populate type-based default values.
            required_only: If True, only include required fields.
            output_format: Output format ("pretty" or "compact").
        """
        self.schema_path = schema_path
        self.output_path = output_path
        self.fill_defaults = fill_defaults
        self.required_only = required_only
        self.output_format = output_format

    def invoke(self) -> None:
        """Execute the invoice generation command.

        Raises:
            typer.Abort: If generation or validation fails.
        """
        # Implementation here
        pass

    def _info_msg(self, msg: str) -> None:
        """Display info message to user."""
        typer.echo(msg)

    def _success_msg(self, msg: str) -> None:
        """Display success message to user."""
        typer.echo(typer.style(msg, fg=typer.colors.GREEN))

    def _error_msg(self, msg: str) -> None:
        """Display error message to user."""
        typer.echo(typer.style(f"Error! {msg}", fg=typer.colors.RED))
```

### Step 2: Implement invoke() method with error handling
```python
def invoke(self) -> None:
    """Execute the invoice generation command.

    Process flow:
    1. Validate schema file exists
    2. Generate invoice using generator service
    3. Write to output path with appropriate formatting
    4. Display success/error messages

    Raises:
        typer.Abort: If generation or validation fails.
    """
    from rdetoolkit.invoice_generator import generate_invoice_from_schema
    from rdetoolkit.exceptions import InvoiceSchemaValidationError

    try:
        self._info_msg(f"Generating invoice from schema: {self.schema_path}")

        # Generate invoice
        invoice_data = generate_invoice_from_schema(
            self.schema_path,
            output_path=None,  # Get dict first, then format and write
            fill_defaults=self.fill_defaults,
            required_only=self.required_only,
        )

        # Write with appropriate formatting
        self._write_invoice(invoice_data)

        self._success_msg(f"Successfully generated: {self.output_path}")

    except FileNotFoundError as e:
        logger.exception(e)
        self._error_msg(f"Schema file not found: {self.schema_path}")
        raise typer.Abort from e

    except InvoiceSchemaValidationError as e:
        logger.exception(e)
        self._error_msg(f"Generated invoice failed validation: {e}")
        raise typer.Abort from e

    except Exception as e:
        logger.exception(e)
        self._error_msg(f"Failed to generate invoice: {e}")
        raise typer.Abort from e


def _write_invoice(self, invoice_data: dict[str, Any]) -> None:
    """Write invoice data to file with specified format.

    Args:
        invoice_data: Invoice data dictionary to write.
    """
    import json
    from rdetoolkit.fileops import writef_json

    # Ensure parent directory exists
    self.output_path.parent.mkdir(parents=True, exist_ok=True)

    if self.output_format == "pretty":
        writef_json(self.output_path, invoice_data, indent=4)
    else:  # compact
        with open(self.output_path, "w", encoding="utf-8") as f:
            json.dump(invoice_data, f, ensure_ascii=False, separators=(',', ':'))
```

### Step 3: Create comprehensive test suite
Design EP/BV test tables first, then implement tests:

**Test Categories**:
1. **Successful Generation Tests**
   - With defaults, all fields (EP-001)
   - Without defaults (EP-002)
   - Required fields only (EP-003)
   - Pretty format (EP-004)
   - Compact format (EP-005)

2. **Error Handling Tests**
   - Schema file not found (BV-001)
   - Invalid schema structure (BV-002)
   - Validation failure (BV-003)
   - Permission error on output (BV-004)

3. **Output Tests**
   - File created at correct path
   - Parent directories created
   - Correct JSON formatting
   - Success messages displayed

4. **Message Display Tests**
   - Info messages shown
   - Success messages shown
   - Error messages shown
   - typer.Abort raised on failure

## Completion Criteria
- [x] File `src/rdetoolkit/cmd/gen_invoice.py` created
- [x] Command class follows pattern from existing commands (e.g., GenerateExcelInvoiceCommand)
- [x] All methods have Google Style docstrings
- [x] All methods have complete type hints (mypy passes)
- [x] Test design tables (EP/BV) documented in test file
- [x] Unit tests implemented with 100% branch coverage
- [x] Tests follow Given/When/Then structure
- [x] Mock invoice_generator service in tests
- [x] `tox -e py312-module -- tests/cmd/test_gen_invoice.py` passes
- [x] `tox -e mypy` passes
- [x] `tox -e ruff` passes

## Notes
- Follow the pattern from `GenerateExcelInvoiceCommand` in `cmd/gen_excelinvoice.py`
- Use lazy imports inside methods to minimize startup cost
- Ensure proper error handling with typer.Abort
- Display user-friendly messages for all operations
- Logger should log exceptions before raising typer.Abort
- Command should be instantiable and testable independently of CLI

## Example Test Structure
```python
# tests/cmd/test_gen_invoice.py

import pytest
from pathlib import Path
from unittest.mock import Mock, patch
from rdetoolkit.cmd.gen_invoice import GenerateInvoiceCommand


class TestGenerateInvoiceCommand:
    """Test suite for GenerateInvoiceCommand.

    EP/BV Test Design:
    ==================

    | Test Case | schema_exists | generator_returns | fill_defaults | format  | Expected Result |
    |-----------|---------------|-------------------|---------------|---------|-----------------|
    | EP-001    | True          | valid dict        | True          | pretty  | File created, pretty JSON |
    | EP-002    | True          | valid dict        | False         | pretty  | File created, no defaults |
    | EP-003    | True          | valid dict        | True          | compact | File created, compact JSON |
    | BV-001    | False         | N/A               | True          | pretty  | typer.Abort, error msg |
    | BV-002    | True          | raises error      | True          | pretty  | typer.Abort, error msg |
    | ...       | ...           | ...               | ...           | ...     | ... |
    """

    def test_ep001_successful_generation_pretty_format(self, tmp_path):
        # Given: Valid schema and command configured for pretty format
        schema_path = tmp_path / "invoice.schema.json"
        schema_path.write_text('{"$schema": "...", "type": "object"}')
        output_path = tmp_path / "output" / "invoice.json"

        cmd = GenerateInvoiceCommand(
            schema_path=schema_path,
            output_path=output_path,
            fill_defaults=True,
            output_format="pretty"
        )

        # When: Invoke command with mocked generator
        with patch("rdetoolkit.cmd.gen_invoice.generate_invoice_from_schema") as mock_gen:
            mock_gen.return_value = {"datasetId": "test", "basic": {}}
            cmd.invoke()

        # Then: File created with pretty formatting
        assert output_path.exists()
        content = output_path.read_text()
        assert "    " in content  # Indentation indicates pretty format
        assert '"datasetId"' in content

    def test_bv001_schema_not_found_raises_abort(self, tmp_path):
        # Given: Non-existent schema path
        schema_path = tmp_path / "nonexistent.json"
        output_path = tmp_path / "invoice.json"

        cmd = GenerateInvoiceCommand(
            schema_path=schema_path,
            output_path=output_path,
        )

        # When/Then: Invoke raises typer.Abort
        with pytest.raises(typer.Abort):
            cmd.invoke()
```
